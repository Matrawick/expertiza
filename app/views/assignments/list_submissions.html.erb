<!--E1877 script added to sort the table-->
<script>
  $(function () {
    /*E1877: Function for sorting the table */
    $("#submissionsTable").tablesorter({
      sortList: [[0,0]] //E1877: sort First Column by default when page loads
    });
  });
</script>
<!--Starting-->
<% headers = {} %>
<% headers["Topic_name"] = "16%" if @assignment.topics? %>
<% if @assignment.max_team_size > 1 %>
  <% headers["Team name"] = "14%" %>
  <% headers["Team member(s)"] = "18%" %>
<% else %>
  <% headers["Participant name"] = "18%" %>
<% end %>                              
<% headers["Submitted item(s)"] = nil %>
<!--E1877: table id changed -->
<table id ="submissionsTable" class="table table-striped" style="margin-top: 50px">
    <thead>
    <!--E1877: class="sorter-true" added to sort all attributes-->
      <tr>
        <% if @assignment.topics? %>
          <th class="sorter-true" style="font-weight: bold; font-size: 15px;">Topic name</th>
        <% end %>
        <% if @assignment.max_team_size > 1 %>
          <th class="sorter-true" style="font-weight: bold; font-size: 15px;">Team name</th>
          <th class="sorter-true" style="font-weight: bold; font-size: 15px;">Team member(s)</th>
        <% else %>
          <th class="sorter-true" style="font-weight: bold; font-size: 15px;">Participant name</th>
        <% end %>  
        <th class="sorter-true" style="font-weight: bold; font-size: 15px;">Links</th> 
        <th class="sorter-false" style="font-weight: bold; font-size: 15px;"></th>
      </tr>                    
    </thead>
    <% @l = -1 %>
    <% @teams.each do |team| %>
      <% @l = @l+1 %>
      <tr>
        <% topic_id, topic_identifier, topic_name, users_for_curr_team, participants = get_data_for_list_submissions(team) %>

        <!--Topic name-->
        <% if @assignment.topics? %>
          <td><%= topic_identifier + '. ' + topic_name %></td>
        <% end %>

        <!--Team name-->
        <% if @assignment.max_team_size > 1 %>
          <% team_name_color = get_team_name_color_in_list_submission(team) %>
          <td><p style = <%="color:#{team_name_color}"%>><%= team.name %></p>
          <!-- A similar code exists as a partial with a few different conditions named as _responses -->
          <!-- Future work can be carried out in refactoring/combining this code and _responses into one partial -->
          <!-- Also, UI test cases can be considered to be written for this functionality (the similar existing _responses partial also does not have any) -->
          <% unless participants.empty? %>
            <!-- Display "Assign Grade" link after final deadline of assignment has passed -->
            <% if @assignment.get_current_stage() == "Finished" %>
              <%= link_to 'Assign grade', { controller: 'grades', action: 'view_team', id: participants.first.id}, target: '_blank' %><br>
            <% end %>
            <!-- Checking if logged in user (instructor/TA) is participant in assignment -->
            <% reviewer = Participant.find_by(:parent_id => @assignment.id, :user_id => session[:user].id)%>
            <!-- Reviewing options are available only to "participants" of assignment -->
            <!-- So only if reviewer is not nil, following applicable links will be displayed -->
            <% if !reviewer.nil? %>
              <!-- Checking if instructor/TA has been mapped to current team -->
              <% @mapping = ReviewResponseMap.find_by(:reviewed_object_id => @assignment.id, :reviewer_id => reviewer.id, :reviewee_id => team.id) %>
              <!-- If mapping is nil, a response cannot be created. So user should be able to "Begin Review" during any review stage, or after deadline has passed -->
              <% if @mapping.nil? && (@assignment.get_current_stage() == "review" || @assignment.get_current_stage() == "Finished")  %>
                <% ReviewResponseMap.create(reviewee_id: team.id, reviewer_id: reviewer.id, reviewed_object_id: @assignment.id) %>
                <% map = ReviewResponseMap.find_by(reviewee_id: team.id, reviewer_id: reviewer.id, reviewed_object_id: @assignment.id) %>
                <%= link_to 'Begin review', { controller: 'response', action: 'new', :id => map.id, :return => "ta_review" } %><br>
              <!-- Any time during review or after deadline, user is given the flexibility to begin, edit or update their review -->
              <% elsif @assignment.get_current_stage() == "review" ||  @assignment.get_current_stage() == "Finished" %>
                <% map1 = ReviewResponseMap.find_by(reviewee_id: team.id, reviewer_id: reviewer.id, reviewed_object_id: @assignment.id) %>
                <% @sorted_responses = Array.new %>
                <% @sorted_responses = Response.where(:map_id => map1.id) %>
                <!-- This means that mapping is created, but user never began the review. Hence linking to "Begin Review" -->
                <% if @sorted_responses.empty?%>
                  <%= link_to 'Begin review', { controller: 'response', action: 'new', :id => map1.id, :return => "ta_review" } %><br>
                <% else %>
                  <!-- There is at least more than one response. Hence we obtain latest response of them all. -->
                  <% @sorted_responses = @sorted_responses.sort_by {|obj| obj.updated_at} # the latest should be at the last %>
                  <% @latest_response = @sorted_responses.last %>
                  <%if @latest_response.round.nil?%>        <!-- Getting current round as last response round in unavailable -->
                      <% last_response_round = AssignmentDueDate.done_in_assignment_round(@assignment.id, @latest_response) %>
                  <%else%>                                  <!-- Getting round in which the last response was given -->
                      <% last_response_round = @latest_response.round %>
                  <%end%>
                  <% current_round = @assignment.number_of_current_round(topic_id) %>
                  <!-- Always displaying "View Review" link for latest response, as long as at least one response exists -->
                  <%= link_to "View review", {:controller => 'response', :action => 'view', :id => @latest_response.id} %><br>
                  <% if last_response_round == current_round %>
                  <% latest_submission = team.most_recent_submission %>
                    <% if !@latest_response.is_submitted %>               <!-- Allow to "Edit" review which has not been submitted yet -->
                      <%= link_to "Edit review", {:controller => 'response', :action => 'edit', :id => @latest_response.id, :return => "ta_review" } %>
                    <% else %>                                            <!-- Allow to "Update" review if team has updated their submission -->
                      <%= link_to "Update review", {:controller => 'response', :action => 'new', :id => map1.id, :return => "ta_review" } %>
                    <%end%>
                  <% else %>                                              <!-- Allow to "Update" review when round changes -->
                    <%= link_to "Update review", {:controller => 'response', :action => 'new', :id => map1.id, :return => "ta_review" } %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
          </td>
        <% end %>

        <!--Team member(s) / Participant name-->
          <td>
              <% users_for_curr_team.each do |user| %>
                  <%= link_to user.name(session[:ip]), impersonate_impersonate_path(:user => {:name => user.name(session[:ip])}), :method => :post %>
                  (<%= user.fullname(session[:ip])%>)<br>
              <% end %>
          </td>

        <!--Submitted item(s)-->
        <td>
        <!--Display submitted hyperlinks-->
          <% participant = participants.compact.first %>
          <% if participant and !team.hyperlinks.empty? %>
            <% team.hyperlinks.each do |link| %>
              <a href="<%= link %>" target="_blank">- <%= link %></a><br/>
            <% end %>
          <% end %>
          <br>
          <!--Display submitted files-->
          <% p team.submitted_files %>
          <% if participant and !team.submitted_files.empty? %>
            <% files = team.submitted_files %>
            <%= display_directory_tree(participant, files, true).html_safe if files and files.length > 0 %>
          <% end %>
        </td>
        <td width="10%">

          <%= link_to "History", submission_records_path(team_id: team.id) %>

        </td>
      </tr>
    <% end %>
  </table>
  <p> **In "Team name" column, text in <i style = "color:#0984e3">blue</i> indicates that the submission grade is not assigned; text in <i style = "color: #cd6133">brown</i> indicates that the submission grade has been assigned.</p>
</div>
